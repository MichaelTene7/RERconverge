---
title: "RERConverge: walk-through of binary trait analysis"
author: "Wynn Meyer"
date: "10/17/2017"
output: html_document
bibliography: RERConverge.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## RERConverge

This walk-through provides instructions for implementing the RERConverge package to identify genes whose evolutionary rates shift in association with change in a binary trait. For information on how to download and install RERConverge, see the README on <a href="https://github.com/nclark-lab/RERconverge" target="_blank">github</a>.

As an example, we will run the code in the `runMarineSub` script in the vignettes folder. 

## Reading in gene trees

To run RERconverge, you will first need to supply a file containing **gene trees** for all genes to be included in your analysis. This is a tab delimited file with the following information on each line:

Gene_name    Newick_tree

An example file is provided in *data/mammal_62_aa_sub.tre*, which you can view in any text editor.

In R, load the RERConverge library and read in the gene trees. The `readTrees` function takes quite a while to read in trees for all genes, so we will limit ourselves to the first 100 using `max.read`:
```{r, include = FALSE}
#This is a temporary alternative to using library in the next code block.
source('../R/enrichmentFuncs.R')
source('../R/plottingFuncs.R')
source('../R/projection_coevo.R')
source('../R/RERfuncs.R')
```

```{r, cache = TRUE}
#library("RERconverge")
mamTrees=readTrees("../data/mammal62aa_meredplus_wCM.trees", max.read = 200)
```

First, the code tells us that the maximum number of tips in the gene trees is 62. It then reports that it will use the 32 genes in this set that have data for all 62 species to estimate a *master tree*. The tree topology for the master tree (but not its branch lengths) will be used for subsequent analyses.

The figure here is a log-scale plot of the variance versus the mean for all possible branch lengths in the tree, summarized across all genes in the dataset. Where the relationship between mean and variance starts to break down for very small values (in this case very large negative values) can be an indicator of the point at which values are too close to zero to provide accurate information for analyses. In our example plot, this happens around $10^{-7}$. We use approximately this value as our cutoff to exclude short branches in further analyses.

### Estimating relative evolutionary rates (RER)

The next step is to estimate **relative evolutionary rates**, or RER, for all branches in the tree for each gene. Intuitively, a gene's RER for a given branch represents how quickly or slowly the gene is evolving on that branch, relative to its overall rate of evolution throughout the tree. For more details about how RER are computed, see [@Chikina2016] and [@Partha2017].

We will use the recommended settings to calculate RER. The input variable `useSpecies` is a vector that can be used to specify a subset of species to use in the analysis; here we will use the full set of tip labels in the master tree. We will also filter any branches shorter than 0.001 using `cutoff` (see above for estimating a reasonable cutoff from the mean-variance plot). Here is the basic method, with the recommended settings:
```{r, message = FALSE, cache = TRUE}
mamRERlogW=getAllResiduals(mamTrees,useSpecies=mamTrees$masterTree$tip.label, transform = "log", weighted = T, cutoff=0.001)
```

When you run this locally, it will print out *i=N* for a series of numbers. This shows for how many genes the function has estimated RER.

When you are running analyses for many genes, it is helpful to scale the raw RER to account for the variance across genes. This is helpful in estimating the empirical significance of particular genes in downstream analyses. Here is the function to scale RER:
```{r, message = FALSE, cache = TRUE}
mamRERlogWs=scale(mamRERlogW)
```

<<<<<<< HEAD:vignettes/WalkThroughBinaryVignette.Rmd
*Optional add-in: Add a plot showing RERs. What is the best way to illustrate this? Where are the visualization scripts?
-gene tree
-average tree
-plot of RERs by species 

## Reading in or generating trait trees

Now we will associate variation in these RERs with variation in traits. To do so, we first need to provide information about the trait distribution across the tree.
=======
We can visualize the RERs for any given gene using the `plotRers` function. Here is an example.

```{r fig1, fig.height=9,fig.width=10, message = FALSE, cache = TRUE}
masterrooted <- root(mamTrees$masterTree,outgroup=c("Platypus","Wallaby","Tasmanian_devil","Opossum"))
wspmr <- masterrooted$tip.label[masterrooted$edge[,2]]
wmvole <- which(wspmr=="Vole")
wmsquirrel <- which(wspmr=="Squirrel")
colMaster <- c(rep("black",length(masterrooted$edge)))
colMaster[wmvole] <- "blue"
colMaster[wmsquirrel] <- "red"
tb3 <- root(mamTrees$trees$BEND3,outgroup=c("Wallaby","Tasmanian_devil","Opossum"))
wspbr <- tb3$tip.label[tb3$edge[,2]]
wbvole <- which(wspbr=="Vole")
wbsquirrel <- which(wspbr=="Squirrel")
coltb3 <- c(rep("black",length(tb3$edge)))
coltb3[wbvole] <- "blue"
coltb3[wbsquirrel] <- "red"
par(mfrow=c(1,2))
plot(masterrooted, main = "Average tree",edge.col=colMaster,cex=0.8) #plot average tree
plot(tb3, main = "BEND3 tree",edge.col=coltb3,cex=0.8) #plot individual gene tree
par(mfrow=c(1,1))
plotRers(mamRERs,"BEND3") #plot RERs
```

The upper left plot is a tree with branch lengths representing the average rates across all genes. The upper right plot is the same tree, but with branch lengths representing rates specifically for the BEND3 gene. The plot below these represents the estimated RERs for terminal branches. Notice how the RER for rat is negative; this is because the branch leading to rat in the BEND3 tree is shorter than average. On the other hand, the RER for squirrel is positive because the branch leading to squirrel in the BEND3 tree is longer than average.

>>>>>>> 172365ac250d459dd2b8006163984d8e22e1ce24:vignettes/WalkThroughBinaryVignetteWynn.Rmd

# References
